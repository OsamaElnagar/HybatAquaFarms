# Comprehensive Enhancement Plan for Intelligent Cash Transactions

This plan outlines the transformation of the Petty Cash system from a simple record-keeping tool into an intelligent, event-driven module that integrates with HR, Procurement, and Operations.

## 1. Architectural Foundation: The "Smart Category" System

Instead of hardcoding logic (like `WORKER_SALARY`), we will make the `ExpenseCategory` model the "brain" that dictates behavior.

### 1.1 Database Enhancements
We will modify the `expense_categories` table to include behavioral configuration:
- **`behavior_type`** (Enum): Defines what extra data/actions are needed.
  - Options: `standard`, `employee_advance`, `vendor_payment`, `harvest_expense`, `driver_allowance`.
- **`requires_approval`** (Boolean): If true, transactions trigger an approval workflow.
- **`requires_attachment`** (Boolean): Enforces receipt uploads.
- **`budget_limit`** (Decimal, nullable): Optional monthly cap for alerts.

### 1.2 The Strategy Pattern
We will implement a `TransactionHandler` interface. Each `behavior_type` will map to a specific class (e.g., `EmployeeAdvanceHandler`, `VendorPaymentHandler`) responsible for:
1.  **Form Schema**: Injecting specific fields into the Filament form (e.g., `employee_id`, `trader_id`).
2.  **Post-Processing**: Executing logic after the transaction is saved (e.g., creating an Advance record, updating Vendor balance).

---

## 2. Category Mapping & Business Logic

We will implement the following intelligent behaviors:

| Category Type | Triggered Action | Required Data | Business Value |
| :--- | :--- | :--- | :--- |
| **Worker Salary** | Creates `EmployeeAdvance` record (Approved/Active). | `employee_id` | Auto-deduct from next payroll; Real-time debt tracking. |
| **Vendor Payment** | Creates a `Voucher` (Payment) & updates `Trader` balance. | `trader_id`, `invoice_ref` | Keeps Accounts Payable up-to-date instantly. |
| **Harvest Expense** | Allocates cost to a specific `Harvest` batch. | `harvest_id`, `operation_id` | Accurate Cost of Goods Sold (COGS) per harvest cycle. |
| **Driver/Fuel** | Logs usage stats (if Vehicle module exists) or links to Driver. | `driver_id`, `vehicle_id` | Track fleet costs and driver spending patterns. |
| **Standard** | Simple logging (default). | None | General administrative expenses. |

---

## 3. Advanced Features Roadmap

### 3.1 Automated Approval Workflows
- **Trigger**: If `ExpenseCategory.requires_approval` is true OR amount > Global Threshold (e.g., 5000 EGP).
- **Action**: Transaction created with status `Pending`.
- **Notification**: Sent to `Farm Manager` or `Accountant`.
- **Result**: Funds are not deducted from "Current Balance" until approved.

### 3.2 Budget Intelligence
- **Real-time Alert**: When selecting a category, if `MonthTotal + CurrentAmount > BudgetLimit`, show a warning toast.
- **Reporting**: "Budget vs Actual" dashboard widget for each category.

### 3.3 Receipt Validation
- **Enforcement**: If `requires_attachment` is on, the "Save" button is disabled until a file is uploaded.

---

## 4. Implementation Roadmap

### Phase 1: Core Refactoring (Immediate)
1.  Create `ExpenseCategoryBehavior` Enum.
2.  Add columns to `expense_categories` migration.
3.  Refactor `PettyCashTransactionForm` to use a dynamic schema builder based on selected category.
4.  Refactor `PettyCashTransactionObserver` to delegate logic to Handler classes.

### Phase 2: Integrations (Short Term)
1.  Implement **Vendor Payment** handler (connect to `Trader` & `Voucher`).
2.  Implement **Harvest Expense** handler (connect to `Harvest`).

### Phase 3: Controls (Medium Term)
1.  Add Approval Workflow columns and UI actions.
2.  Implement Budget Alerting logic.

## 5. Next Steps
Shall we proceed with **Phase 1**? I will:
1.  Create the migration for `expense_categories`.
2.  Set up the Strategy Pattern structure.
3.  Migrate the existing `WORKER_SALARY` logic into the new system.
