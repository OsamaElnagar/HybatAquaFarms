I will refactor the Petty Cash system to support a Many-to-Many relationship between Petty Cashes and Farms, and track the Farm for each transaction.

### 1. Database Migration

I will create a migration `restructure_petty_cash_relationships` to:

1. Create a pivot table `farm_petty_cash` with `farm_id` and `petty_cash_id`.
2. Add a `farm_id` column to the `petty_cash_transactions` table (foreign key to `farms`) (nullable).
3. **Migrate existing data**:

   * Copy existing `petty_cashes.farm_id` relationships to the new `farm_petty_cash` table.

   * Populate the new `petty_cash_transactions.farm_id` based on the related Petty Cash's current farm.
4. Drop the old `farm_id` column from the `petty_cashes` table.

### 2. Model Updates

* **PettyCash Model**:

  * Replace `farm()` (BelongsTo) with `farms()` (BelongsToMany).

  * Remove `farm_id` from fillable attributes.

* **Farm Model**:

  * Replace `pettyCash()` (HasMany) with `pettyCashes()` (BelongsToMany).

  * Update `pettyCashTransactions` relationship to be a direct `hasMany` (since we are adding `farm_id` to transactions).

* **PettyCashTransaction Model**:

  * Add `farm()` (BelongsTo) relationship.

  * Add `farm_id` to fillable attributes.

### 3. Filament Resource Updates

* **PettyCashResource (PettyCashForm)**:

  * Replace the single `farm_id` Select with a multi-select field for `farms` allowing users to assign multiple farms to a petty cash.

* **PettyCashTransactionResource (PettyCashTransactionForm)**:

  * Add a `farm_id` Select field.

  * Make it **reactive** to the `petty_cash_id` selection.

  * Dynamically populate options to show only farms assigned to the selected Petty Cash.

  * **Auto-select logic**: If the selected Petty Cash is assigned to only one farm, automatically select it.

### 4. Verification

* Verify the database schema changes and data integrity.

* Test creating/editing a Petty Cash with multiple farms.

* Test creating a Transaction and verifying the Farm selection logic.

