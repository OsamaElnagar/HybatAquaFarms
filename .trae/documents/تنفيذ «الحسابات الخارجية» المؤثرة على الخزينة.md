**الفكرة العامة**

* إنشاء كيان مستقل لتسجيل عمليات نقدية خارج دورة العمل الأساسية، دون ربط بطرف/كيان.

* يعتمد القيد المزدوج: عند الدفع (صرف) → دائن الخزينة ومدين حساب مصروف، وعند القبض → مدين الخزينة ودائن حساب إيراد.

* واجهة Filament كاملة (قائمة/إنشاء/تعديل/عرض) مع صلاحيات وتحقق صارم من نوع الحساب.

**نموذج البيانات**

* ExternalCalculation:

  * الحقول: id، farm\_id (nullable)، treasury\_account\_id، type (Receipt/Payment)، amount، date، account\_id (الحساب المقابل: مصروف/إيراد)، reference\_number، description، created\_by، journal\_entry\_id (اختياري للربط)، timestamps.

  * العلاقات: farm، treasuryAccount → [Account](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Models/Account.php)؛ account → \[Account]؛ createdBy → User؛ journalEntry → [JournalEntry](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Models/JournalEntry.php).

  * Enum: ExternalCalculationType (Receipt, Payment) مشابه لأنماط [VoucherType](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Models/Voucher.php#L39-L47).

**الهجرات**

* جدول external\_calculations:

  * مفاتيح خارجية: farm\_id (cascade)، treasury\_account\_id وaccount\_id (nullOnDelete)، created\_by (nullOnDelete)، journal\_entry\_id (nullOnDelete).

  * فهارس: unique مركب اختياري (farm\_id, date, reference\_number)، index(date, type), index(farm\_id).

  * قيود تحقق على مستوى التطبيق: amount > 0؛ treasury\_account.is\_treasury = true؛ توافق نوع الحساب: Payment → Expense، Receipt → Income.

**المنطق المحاسبي والترحيل**

* مراقب ExternalCalculationObserver:

  * after creating: بناء سياق الترحيل واستدعاء PostingService.post كما في [VoucherObserver](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Observers/VoucherObserver.php#L20-L43).

  * التعيين:

    * Payment: debit\_account\_id = account\_id (مصروف)، credit\_account\_id = treasury\_account\_id.

    * Receipt: debit\_account\_id = treasury\_account\_id، credit\_account\_id = account\_id (إيراد).

  * تخزين المرجع إلى الـ JournalEntry الناتج (journal\_entry\_id).

* عدم الحاجة لإضافة قاعدة ثابتة في [PostingRule](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Models/PostingRule.php): نمرر الحسابات مباشرة مثل السندات.

* استخدام نفس خدمة الترحيل: [PostingService](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Domain/Accounting/PostingService.php) لضمان الاتساق مع القيد المزدوج وخانة التوازن في [JournalEntry](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Models/JournalEntry.php#L54-L68).

**واجهة Filament**

* مورد: ExternalCalculationResource ضمن app/Filament/Resources/ExternalCalculations/.

* النموذج (Schema):

  * farm مع ربط تلقائي إن اختيرت العهدة من مزرعة؛ date؛ type (Badge/Select)؛ treasury\_account\_id (اختيار من accounts.treasury scoped بالمزرعة)؛ account\_id:

    * يظهر قائمة حسابات Expense إذا type=Payment، وقائمة حسابات Income إذا type=Receipt.

  * amount؛ reference\_number؛ description؛ created\_by افتراضيًا المستخدم الحالي.

  * تحقق حي (live) كما في [VoucherForm](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Filament/Resources/Vouchers/Schemas/VoucherForm.php#L22-L143).

* الجدول (Table):

  * أعمدة: رقم داخلي/مرجع، النوع كشارة، التاريخ، المزرعة، العهدة، الحساب المقابل، المبلغ (ملون حسب الاتجاه)، طريقة فرز/تصنيف حسب النوع والتاريخ، مجموعات وتجميعات.

* الصفحات: ListExternalCalculations, CreateExternalCalculation, EditExternalCalculation, ViewExternalCalculation مماثلة لمورد [Vouchers](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Filament/Resources/Vouchers/VoucherResource.php).

**الصلاحيات والسياسات**

* Policy: السماح بالقراءة للجميع حسب الدور المناسب؛ الإنشاء/التعديل للمستخدمين المخولين ماليًا؛ منع حذف قيود منشورة إلا عبر «إلغاء» مضبوطة إن لزم.

* إخفاء الحسابات غير النشطة؛ التحقق من انتماء الحسابات لنفس المزرعة.

**التقارير والتكامل**

* ودجت بسيطة على صفحة القائمة: إجمالي المقبوضات/المدفوعات للفترة المحددة.

* علاقة اختيارية ضمن مورد المزرعة (RelationManager) لعرض «الحسابات الخارجية» الخاصة بالمزرعة.

* ربط قيود اليومية الناتجة في صفحة العرض.

**البذور (اختياري)**

* إضافة حساب «إيرادات متنوعة» 4800 إن لم يوجد، وحساب «مصروفات متنوعة» 5280 لتسهيل الاستخدام الأولي، عبر Seeder مشابه لـ [AccountSeeder](file:///d:/HybatAquaFarms/HybatAquaFarms/database/seeders/AccountSeeder.php).

**الاختبارات وضمان الجودة**

* Feature tests:

  * Payment: يتولد قيد يومية بمدين مصروف ودائن خزينة، والتوازن صحيح.

  * Receipt: مدين خزينة ودائن إيراد.

  * رفض إدخال نوع حساب غير مطابق (Expense مع Receipt … إلخ).

* فحص رصيد الخزينة عبر [TreasuryService](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Services/TreasuryService.php#L38-L47) بعد كل عملية.

**ملاحظة بديلة (إن رغبت بإعادة استخدام «السند»)**

* يمكن جعل counterparty في جدول السندات اختياريًا بتحويل morphs إلى nullableMorphs، وتعديل [VoucherForm](file:///d:/HybatAquaFarms/HybatAquaFarms/app/Filament/Resources/Vouchers/Schemas/VoucherForm.php) للسماح بسند بدون طرف مقابل؛ لكنه تغيير واسع وقد يؤثر على تدفق المبيعات والدفعات الحالية، لذلك الخطة الحالية تفصل الكيان لتجنّب المخاطر.

**المخرجات**

* ملفات: Migration + Model + Observer + Resource (Schema/Table/Pages) + Policy + اختبارات.

* تجربة استخدام متسقة مع الموارد الحالية، مع أثر مباشر وواضح على الخزينة وقيود اليومية.

