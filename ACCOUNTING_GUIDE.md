# الدليل المحاسبي للنظام (Accounting Guide)

مرحباً بك. هذا الملف يشرح ببساطة كيفية عمل النظام المالي والمحاسبي في المشروع، مع ترجمة المصطلحات الصعبة وتوضيح "دورة حياة الأموال" (Money Lifecycle).

---

## 1. المفاهيم الأساسية (Core Concepts)

لفهم الكود، يجب فهم هذه المكونات الخمسة:

### أ. الحساب (Account)
هو "الوعاء" الذي نضع فيه المال أو القيمة. لكل حساب رقم (Code) واسم.
*   **1110 - النقدية (Cash)**: المال الموجود فعلياً في الخزنة.
*   **1140 - الذمم المدينة (Accounts Receivable)**: المال الذي لنا عند التجار (ديون عليهم).
*   **4100 - المبيعات (Sales Revenue)**: قيمة البضاعة التي بعناها.
*   **5000 - المصروفات (Expenses)**: الكهرباء، العلف، الرواتب.

### ب. القيد المحاسبي (Journal Entry)
هو "سجل رسمي" لأي عملية مالية. لا يمكن حذف أو تعديل القيد بعد ترحيله (Posting) لضمان الأمانة.
*   كل قيد يتكون من طرفين على الأقل: **مدين (Debit)** و **دائن (Credit)**.
*   قاعدة ذهبية: **مجموع المدين يجب أن يساوي مجموع الدائن**.

### ج. طرف القيد (Journal Line)
هو السطر الواحد داخل القيد.
*   **مدين (Debit)**: يعني "أخذ" أو "زاد" (في حالة الأصول والمصروفات).
*   **دائن (Credit)**: يعني "أعطى" أو "نقص" (في حالة الأصول) أو "زاد" (في حالة الإيرادات والخصوم).

> **مثال بسيط:** عند بيع سمك نقداً بـ 1000 جنيه:
> 1. حساب النقدية (أصل) زاد <-- **مدين (Debit)** بـ 1000.
> 2. حساب المبيعات (إيراد) زاد <-- **دائن (Credit)** بـ 1000.

### د. السند (Voucher)
هو "الوثيقة" التي تثبت الدفع أو القبض.
*   **سند قبض (Receipt Voucher)**: عندما نأخذ مال من تاجر.
*   **سند صرف (Payment Voucher)**: عندما ندفع مال لمورد أو موظف.
*   السند هو ما يقوم المستخدم بإنشائه، والنظام يقوم تلقائياً بإنشاء "القيد المحاسبي" المقابل له.

### هـ. قواعد الترحيل (Posting Rules)
هي "الخريطة" التي تخبر النظام كيف يحول الأحداث (مثل بيع سمك) إلى قيود محاسبية.
*   مثال: قاعدة `sales.credit` تقول للنظام: "عندما يحدث بيع آجل، اجعل حساب العملاء مديناً وحساب المبيعات دائناً".

---

## 2. دورة العمل والمال (Workflows & Treasury Impact)

كيف تتأثر الخزنة (Treasury) بالأحداث اليومية؟

### 1. بيع السمك (Sales Cycle)
هنا لدينا حالتان:

**أ. بيع آجل (Credit Sale) - الأكثر شيوعاً:**
1.  يتم إنشاء **أمر بيع (Sales Order)** بحالة "Pending".
2.  **الأثر المحاسبي**:
    *   زيادة في **الذمم المدينة (Receivables)** (لنا فلوس عند التاجر).
    *   زيادة في **المبيعات (Sales)**.
    *   ⚠️ **الخزنة**: لا تتأثر بعد.
3.  عندما يدفع التاجر، نضغط **"تسجيل دفعة" (Register Payment)**.
4.  يتم إنشاء **سند قبض (Receipt Voucher)**.
5.  **الأثر المحاسبي**:
    *   زيادة في **الخزنة (Cash)** (دخل فلوس).
    *   نقص في **الذمم المدينة (Receivables)** (دين التاجر قل).

**ب. بيع نقدي (Cash Sale):**
1.  يتم إنشاء أمر بيع بحالة "Paid".
2.  **الأثر المحاسبي**:
    *   زيادة مباشرة في **الخزنة (Cash)**.
    *   زيادة في **المبيعات (Sales)**.

### 2. المصروفات والمشتريات (Expenses & Purchases)
مثل شراء العلف، أو دفع الرواتب.

1.  يتم إنشاء **سند صرف (Payment Voucher)**.
2.  يختار المستخدم "نوع المصروف" (مثلاً: رواتب، صيانة).
3.  **الأثر المحاسبي**:
    *   زيادة في **المصروفات (Expenses)**.
    *   نقص في **الخزنة (Cash)**.

---

## 3. تحليل النظام الحالي (Current System Analysis)

لقد قمت بفحص الكود ووجدت الآتي:

### ✅ نقاط القوة:
1.  النظام يستخدم **Double-Entry Accounting** وهو المعيار العالمي الصحيح.
2.  استخدام **Posting Rules** يجعل النظام مرناً؛ يمكن للمحاسب تغيير توجيه الحسابات دون تعديل الكود.
3.  فصل **Voucher** (الوثيقة) عن **Journal Entry** (الأثر المالي) هو تصميم ممتاز.

### ⚠️ نقاط تحتاج انتباه (Weaknesses & Fixes):
1.  **مشكلة في "تسجيل الدفعة" (Register Payment)**:
    *   حالياً، عند تسجيل دفعة لأمر بيع، النظام قد يوجه الدفعة لحساب "الإيرادات" مرة أخرى بدلاً من خصمها من "مديونية التاجر".
    *   **الحل**: سأقوم بتعديل الكود لضمان أن الدفعة تخصم من حساب التاجر (Receivables) وليس تسجيل إيراد جديد.
2.  **الخزنة (Treasury)**:
    *   الخزنة في النظام هي مجرد "حساب" (Account) كود `1110` أو `1120`.
    *   أي عملية تؤثر على هذا الحساب ستظهر فوراً في رصيد الخزنة.

---

## 4. ملخص للمطور (Developer Cheat Sheet)

| المصطلح العربي | English Term | Model / Class | الوظيفة |
| :--- | :--- | :--- | :--- |
| **قيد يومية** | Journal Entry | `JournalEntry` | الرأس (Header) للعملية المالية. |
| **طرف قيد** | Journal Line | `JournalLine` | التفاصيل (المبلغ، الحساب، مدين/دائن). |
| **حساب** | Account | `Account` | جدول الحسابات (شجرة الحسابات). |
| **سند** | Voucher | `Voucher` | واجهة المستخدم لإدخال المال أو صرفه. |
| **قاعدة ترحيل** | Posting Rule | `PostingRule` | Config يربط الحدث بالحسابات (Event -> Accounts). |
| **الخزنة** | Treasury / Petty Cash | `PettyCash` | واجهة لتمثيل "الصندوق" أو "العهدة". |

إذا أردت معرفة رصيد الخزنة برمجياً:
```php
// الخيار الأفضل: عبر خدمة الخزنة
$balance = app(TreasuryService::class)->getAccountBalance($account);

// أو عبر الموديل مباشرة (إذا تم تحديثه)
$balance = Account::where('code', '1110')->first()->current_balance;
```
